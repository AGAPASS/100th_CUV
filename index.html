<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>千年薪火 百年和合</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow-x: hidden;
            background: #000;
            height: 100vh;
        }

        .container {
            width: 17060px; /* 与背景图宽度一致 */
            height: 806px; /* 与背景图高度一致 */
            background-image: url('images/layer1/background_layer1.png'); /* 替换背景图路径 */
            position: relative;
            transform: translateX(0);
            transition: transform 0.5s ease;
            will-change: transform;
        }

        .hotspot {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0;
            will-change: opacity, transform;
        }

        .hotspot:hover {
            transform: scale(1.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 999;
            max-width: 80%;
        }

        .modal img {
            max-width: 100%;
            height: auto;
        }

        .close-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            color: white;
            cursor: pointer;
        }

        .music-control {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1000;
            color: white;
            cursor: pointer;
        }

        .rotate-tip {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            text-align: center;
            padding-top: 30%;
            z-index: 9999;
        }

        /* 新增样式 */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            transition: opacity 1s ease;
        }

        .loading-text {
            font-size: 24px;
            margin-top: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .cinematic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 990;
        }

        .cinematic-bar {
            position: absolute;
            width: 100%;
            height: 10%;
            background: #000;
            transition: height 1.5s ease;
            will-change: height;
        }

        .cinematic-bar.top {
            top: 0;
        }

        .cinematic-bar.bottom {
            bottom: 0;
        }

        .scroll-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 50px;
            display: flex;
            gap: 10px;
            transition: opacity 0.5s ease;
            will-change: opacity;
        }

        .scroll-controls button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }

        .scroll-controls button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .intro-image {
            position: absolute;
            max-width: 400px;
            max-height: 300px;
            opacity: 0;
            transition: opacity 1s ease;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            z-index: 100;
            pointer-events: none;
            will-change: opacity;
            transform: translateZ(0);
        }

        /* 新增朦胧效果覆盖层 */
        .dreamy-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            pointer-events: none;
            z-index: 95;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            transition: opacity 1.5s ease;
            will-change: opacity;
        }

        /* 新增弹出图片样式 */
        .popup-image {
            position: fixed;
            max-width: 900px; /* 增大最大宽度 */
            max-height: 700px; /* 增大最大高度 */
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8) translateZ(0); /* 居中显示并使用硬件加速 */
            z-index: 996; /* 高于朦胧层 */
            pointer-events: none;
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            will-change: opacity, transform; /* 提示浏览器这些属性会变化 */
            -webkit-transform: translate(-50%, -50%) scale(0.8) translateZ(0);
            top: 50%;
            left: 25%;
            width: 800px;
        }

        .popup-image.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1) translateZ(0);
            -webkit-transform: translate(-50%, -50%) scale(1) translateZ(0);
        }

        /* 为全屏状态添加样式 */
        .fullscreen-mode .cinematic-bar {
            height: 0 !important;
        }

        .fullscreen-mode .dreamy-overlay {
            opacity: 0;
        }

        .fullscreen-mode .popup-image {
            opacity: 0;
        }

        @media screen and (orientation: portrait) {
            .rotate-tip {
                display: block;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
<!-- 新增加载动画 -->
<div class="loading-screen">
    <div class="spinner"></div>
    <div class="loading-text">正在加载...</div>
</div>

<!-- 新增电影感蒙版 -->
<div class="cinematic-overlay">
    <div class="cinematic-bar top"></div>
    <div class="cinematic-bar bottom"></div>
</div>

<!-- 新增朦胧效果覆盖层 -->
<div class="dreamy-overlay"></div>

<div class="rotate-tip">请将手机横屏观看</div>
<div class="music-control"><i class="fas fa-volume-up"></i></div>
<div class="container">
    <!-- 热点示例 - 需要根据实际位置调整 -->
    <div class="hotspot" style="left: 700px; top: 300px;" data-img="images/layer3/1丝绸之路_画板 1.png"></div>
    <div class="hotspot" style="left: 1950px; top: 220px;" data-img="images/layer3/2最古铁十字架_画板 1.png"></div>
    <div class="hotspot" style="left: 3000px; top: 350px;" data-img="images/layer3/3景教_画板 1.png"></div>
    <div class="hotspot" style="left: 4120px; top: 300px;" data-img="images/layer3/4流行中国碑_画板 1.png"></div>
    <div class="hotspot" style="left: 5100px; top: 500px;" data-img="images/layer3/5聂斯多略派教徒墓碑_画板 1.png"></div>
    <div class="hotspot" style="left: 5980px; top: 350px;" data-img="images/layer3/6也里可温教_画板 1.png"></div>
    <div class="hotspot" style="left: 6700px; top: 500px;" data-img="images/layer3/7孟高维诺译本_画板 1.png"></div>
    <div class="hotspot" style="left: 7350px; top: 30px;" data-img="images/layer3/9闭关锁国_画板 1.png"></div>
    <div class="hotspot" style="left: 8300px; top: 445px;" data-img="images/layer3/8祖传天主十诫_画板 1.png"></div>
    <div class="hotspot" style="left: 8350px; top: 350px;" data-img="images/layer3/10西学东渐_画板 1.png"></div>
    <div class="hotspot" style="left: 8450px; top: 435px;" data-img="images/layer3/11徐光启与几何原本_画板 1.png"></div>
    <div class="hotspot" style="left: 9300px; top: 430px;" data-img="images/layer3/12康熙与十字架（文字）_画板 1_画板 1.png"></div>
    <div class="hotspot" style="left: 10400px; top: 350px;" data-img="images/layer3/13礼仪之争_画板 1.png"></div>
    <div class="hotspot" style="left: 11010px; top: 690px;" data-img="images/layer3/14百年禁教_画板 1.png"></div>
    <div class="hotspot" style="left: 11800px; top: 350px;" data-img="images/layer3/15新教第一人_画板 1.png"></div>
    <div class="hotspot" style="left: 11700px; top: 600px;" data-img="images/layer3/16神天圣书_画板 1.png"></div>
    <div class="hotspot" style="left: 12270px; top: 420px;" data-img="images/layer3/17中国第一位新教徒_画板 1.png"></div>
    <div class="hotspot" style="left: 12800px; top: 300px;" data-img="images/layer3/18大规模中文译经（滑动文字）_画板 1_画板 1_画板 1.png"></div>
    <div class="hotspot" style="left: 13500px; top: 170px;" data-img="images/layer3/19太平天国运动_画板 1.png"></div>
    <div class="hotspot" style="left: 14600px; top: 150px;" data-img="images/layer3/21义和团运动_画板 1.png"></div>
    <div class="hotspot" style="left: 15300px; top: 200px;" data-img="images/layer3/22辛亥革命_画板 1.png"></div>
    <div class="hotspot" style="left: 16300px; top: 200px;" data-img="images/layer3/23五四运动_画板 1.png"></div>
    <div class="hotspot" style="left: 15500px; top: 350px;" data-img="images/layer3/24官话和合本_画板 1.png"></div>

</div>

<div class="modal">
    <span class="close-btn"><i class="fas fa-times"></i></span>
    <img src="" alt="详情图片">
</div>

<!-- 新增滚动控制按钮 -->
<div class="scroll-controls">
    <button id="pause-btn"><i class="fas fa-pause"></i></button>
    <button id="play-btn"><i class="fas fa-play"></i></button>
    <button id="restart-btn"><i class="fas fa-redo"></i></button>
</div>

<audio id="bgm" loop>
    <source src="audio/bgm.mp3" type="audio/mpeg"> <!-- 替换背景音乐 -->
</audio>

<script>
    // 音乐控制
    const musicControl = document.querySelector('.music-control');
    const audio = document.getElementById('bgm');
    let isMuted = false;

    musicControl.addEventListener('click', () => {
        isMuted = !isMuted;
        audio.muted = isMuted;
        musicControl.innerHTML = isMuted ?
            '<i class="fas fa-volume-mute"></i>' :
            '<i class="fas fa-volume-up"></i>';
    });

    // 弹窗控制
    const hotspots = document.querySelectorAll('.hotspot');
    const modal = document.querySelector('.modal');
    const closeBtn = document.querySelector('.close-btn');

    hotspots.forEach(hotspot => {
        hotspot.addEventListener('click', (e) => {
            const imgUrl = e.target.dataset.img;
            modal.querySelector('img').src = imgUrl;
            modal.style.display = 'block';
            pauseScrolling(); // 点击热点时暂停滚动
        });
    });

    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // 自动播放音乐（需要用户交互后）
    document.addEventListener('click', function initAudio() {
        audio.play();
        document.removeEventListener('click', initAudio);
    });

    // 移动端横屏检测
    window.addEventListener('orientationchange', () => {
        if (window.orientation === 90 || window.orientation === -90) {
            document.querySelector('.rotate-tip').style.display = 'none';
        }
    });

    // 新增功能：加载动画、电影感蒙版和卷轴滚动
    const loadingScreen = document.querySelector('.loading-screen');
    const container = document.querySelector('.container');
    const topBar = document.querySelector('.cinematic-bar.top');
    const bottomBar = document.querySelector('.cinematic-bar.bottom');
    const pauseBtn = document.getElementById('pause-btn');
    const playBtn = document.getElementById('play-btn');
    const restartBtn = document.getElementById('restart-btn');
    const dreamyOverlay = document.querySelector('.dreamy-overlay');
    const body = document.body;
    
    // 创建完整的性能监控器
    const performanceMonitor = {
        frameCount: 0,
        lastTime: performance.now(),
        fps: 60,
        lowPerformanceMode: false,
        
        update() {
            this.frameCount++;
            const now = performance.now();
            const elapsed = now - this.lastTime;
            
            if (elapsed >= 1000) {
                this.fps = this.frameCount / (elapsed / 1000);
                this.frameCount = 0;
                this.lastTime = now;
                
                // 检测低性能，并切换模式
                if (this.fps < 30 && !this.lowPerformanceMode) {
                    this.lowPerformanceMode = true;
                    this.enableLowPerformanceMode();
                } else if (this.fps > 40 && this.lowPerformanceMode) {
                    this.lowPerformanceMode = false;
                    this.disableLowPerformanceMode();
                }
            }
        },
        
        enableLowPerformanceMode() {
            console.log("启用低性能模式");
            document.body.classList.add('low-performance-mode');
        },
        
        disableLowPerformanceMode() {
            console.log("禁用低性能模式");
            document.body.classList.remove('low-performance-mode');
        }
    };

    // 图片显示和消失配置
    const introImages = [
        {
            src: "images/layer3/1丝绸之路_画板 1.png", 
            showAtPosition: 600, 
            hideAtPosition: 1200,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer3/2最古铁十字架_画板 1.png", 
            showAtPosition: 1800, 
            hideAtPosition: 2300,
            top: 150, 
            left: 50
        },
        {
            src: "images/layer3/3景教_画板 1.png", 
            showAtPosition: 2900, 
            hideAtPosition: 3400,
            top: 120, 
            left: 50
        },
        {
            src: "images/layer3/4流行中国碑_画板 1.png", 
            showAtPosition: 4000, 
            hideAtPosition: 4500,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer3/5聂斯多略派教徒墓碑_画板 1.png", 
            showAtPosition: 5000, 
            hideAtPosition: 5500,
            top: 150, 
            left: 50
        },
        {
            src: "images/layer3/6也里可温教_画板 1.png", 
            showAtPosition: 5900, 
            hideAtPosition: 6400,
            top: 120, 
            left: 50
        },
        {
            src: "images/layer3/7孟高维诺译本_画板 1.png", 
            showAtPosition: 6600, 
            hideAtPosition: 7100,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer38祖传天主十诫_画板 1.png", 
            showAtPosition: 7300, 
            hideAtPosition: 7800,
            top: 150, 
            left: 50
        },
        {
            src: "images/layer3/9闭关锁国_画板 1.png", 
            showAtPosition: 8200, 
            hideAtPosition: 8700,
            top: 120, 
            left: 50
        },
        {
            src: "images/layer3/10西学东渐_画板 1.png", 
            showAtPosition: 8700, 
            hideAtPosition: 9200,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer3/11徐光启与几何原本_画板 1.png", 
            showAtPosition: 9200, 
            hideAtPosition: 9700,
            top: 150, 
            left: 50
        },
        {
            src: "images/layer3/12康熙与十字架（文字）_画板 1_画板 1.png", 
            showAtPosition: 9800, 
            hideAtPosition: 10300,
            top: 120, 
            left: 50
        },
        {
            src: "images/layer3/13礼仪之争_画板 1.png", 
            showAtPosition: 10400, 
            hideAtPosition: 10900,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer3/14百年禁教_画板 1.png", 
            showAtPosition: 11000, 
            hideAtPosition: 11500,
            top: 150, 
            left: 50
        },
        {
            src: "images/layer3/15新教第一人_画板 1.png", 
            showAtPosition: 11700, 
            hideAtPosition: 12200,
            top: 120, 
            left: 50
        },
        {
            src: "images/layer3/16神天圣书_画板 1.png", 
            showAtPosition: 12300, 
            hideAtPosition: 12800,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer3/17中国第一位新教徒_画板 1.png", 
            showAtPosition: 12900, 
            hideAtPosition: 13400,
            top: 150, 
            left: 50
        },
        {
            src: "images/layer3/18大规模中文译经（滑动文字）_画板 1_画板 1_画板 1.png", 
            showAtPosition: 13500, 
            hideAtPosition: 14000,
            top: 120, 
            left: 50
        },
        {
            src: "images/layer3/19太平天国运动_画板 1.png", 
            showAtPosition: 14100, 
            hideAtPosition: 14600,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer3/21义和团运动_画板 1.png", 
            showAtPosition: 14700, 
            hideAtPosition: 15200,
            top: 150, 
            left: 50
        },
        {
            src: "images/layer3/22辛亥革命_画板 1.png", 
            showAtPosition: 15300, 
            hideAtPosition: 15800,
            top: 120, 
            left: 50
        },
        {
            src: "images/layer3/23五四运动_画板 1.png", 
            showAtPosition: 15900, 
            hideAtPosition: 16400,
            top: 100, 
            left: 50
        },
        {
            src: "images/layer3/24官话和合本_画板 1.png", 
            showAtPosition: 16500, 
            hideAtPosition: 17000,
            top: 150, 
            left: 50
        }
    ];

    // 新增弹出图片配置
    const popupImages = [
        {
            src: "images/layer1/copywriting/1.丝绸之路_画板 1.png", 
            showAtPosition: 10, 
            hideAtPosition: 800
        },
        {
            src: "images/layer1/copywriting/2.最古铁十字架_画板 1.png", 
            showAtPosition: 1000, 
            hideAtPosition: 2000
        },
        {
            src: "images/layer1/copywriting/3.景教入华_画板 1.png", 
            showAtPosition: 2100, 
            hideAtPosition: 3200
        },
        {
            src: "images/layer1/copywriting/4. 大秦景教_画板 1.png", 
            showAtPosition: 3300, 
            hideAtPosition: 4200
        },
        {
            src: "images/layer1/copywriting/5.退居边疆_画板 1.png", 
            showAtPosition: 4300, 
            hideAtPosition: 5000
        },
        {
            src: "images/layer1/copywriting/6.景教复苏_画板 1.png", 
            showAtPosition: 5100, 
            hideAtPosition: 5800
        },
        {
            src: "images/layer1/copywriting/7.天主教入华_画板 1.png", 
            showAtPosition: 5900, 
            hideAtPosition: 6500
        },
        {
            src: "images/layer1/copywriting/8.闭关锁国_画板 1.png", 
            showAtPosition: 6600, 
            hideAtPosition: 7300
        },
        {
            src: "images/layer1/copywriting/9.泰西儒士_画板 1.png", 
            showAtPosition: 7400, 
            hideAtPosition: 7700
        },
        {
            src: "images/layer1/copywriting/10.西学东渐_画板 1.png", 
            showAtPosition: 7800, 
            hideAtPosition: 8400
        },
        {
            src: "images/layer1/copywriting/11.帝师教士_画板 1.png", 
            showAtPosition: 8500, 
            hideAtPosition: 9300
        },
        {
            src: "images/layer1/copywriting/12.利益之争_画板 1.png", 
            showAtPosition: 9400, 
            hideAtPosition: 10300
        },
        {
            src: "images/layer1/copywriting/13.百年禁教_画板 1.png", 
            showAtPosition: 10400, 
            hideAtPosition: 10900
        },
        {
            src: "images/layer1/copywriting/14.新教入华_画板 1.png", 
            showAtPosition: 11100, 
            hideAtPosition: 11900
        },
        {
            src: "images/layer1/copywriting/15.被迫开放_画板 1.png", 
            showAtPosition: 12000, 
            hideAtPosition: 12600
        },
        {
            src: "images/layer1/copywriting/16.太平天国运动_画板 1.png", 
            showAtPosition: 12700, 
            hideAtPosition: 13500
        },
        {
            src: "images/layer1/copywriting/17.帝国覆灭_画板 1.png", 
            showAtPosition: 13600, 
            hideAtPosition: 14300
        },
        {
            src: "images/layer1/copywriting/18.新文化运动_画板 1.png", 
            showAtPosition: 15000, 
            hideAtPosition: 16000
        },
        {
            src: "images/layer1/copywriting/19.和合本面世_画板 1.png", 
            showAtPosition: 14400, 
            hideAtPosition: 14900
        }
    ];

    // 采用更高效的预加载方法
    function preloadImages() {
        console.log("开始预加载图片...");
        const loadPromises = [];
        
        // 收集所有需要预加载的图片
        const imagesToPreload = [];
        introImages.forEach(img => imagesToPreload.push(img.src));
        popupImages.forEach(img => imagesToPreload.push(img.src));
        
        // 创建一个Promise来监控每个图片的加载
        imagesToPreload.forEach(src => {
            loadPromises.push(new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(src);
                img.onerror = () => {
                    console.error(`无法加载图片: ${src}`);
                    resolve(src); // 即使出错也继续
                };
                img.src = src;
            }));
        });
        
        // 当所有图片加载完毕后，才继续
        return Promise.all(loadPromises).then(() => {
            console.log("所有图片预加载完成!");
        });
    }

    // 创建介绍图片元素 - 优化DOM操作
    function createIntroImages() {
        const fragment = document.createDocumentFragment();
        
        introImages.forEach((imgConfig, index) => {
            const imgElement = new Image();
            imgElement.src = imgConfig.src;
            imgElement.className = 'intro-image';
            imgElement.style.top = imgConfig.top + 'px';
            imgElement.style.left = imgConfig.left + 'px';
            imgElement.loading = "eager"; // 使用原生懒加载
            
            fragment.appendChild(imgElement);
            
            // 保存元素引用
            introImages[index].element = imgElement;
        });
        
        container.appendChild(fragment);
    }

    // 创建弹出图片元素 - 优化DOM操作
    function createPopupImages() {
        const fragment = document.createDocumentFragment();
        
        popupImages.forEach((imgConfig, index) => {
            const imgElement = new Image();
            imgElement.src = imgConfig.src;
            imgElement.className = 'popup-image';
            imgElement.loading = "eager"; // 使用原生懒加载
            
            fragment.appendChild(imgElement);
            
            // 保存元素引用
            popupImages[index].element = imgElement;
        });
        
        document.body.appendChild(fragment);
    }

    // 控制卷轴滚动
    let scrollPosition = 0;
    let isScrolling = false;
    let scrollSpeed = 3; // 每帧移动的像素数
    const maxScroll = container.offsetWidth - window.innerWidth;
    let lastFrameTime = 0; // 上一帧的时间戳
    const targetFPS = 60; // 目标帧率
    const frameDuration = 1000 / targetFPS; // 每帧理想持续时间 (ms)
    
    function startScrolling() {
        if (isScrolling) return;
        
        isScrolling = true;
        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-flex';
        lastFrameTime = performance.now();
        requestAnimationFrame(scrollAnimation);
    }
    
    function pauseScrolling() {
        isScrolling = false;
        playBtn.style.display = 'inline-flex';
        pauseBtn.style.display = 'none';
    }
    
    function resetScrolling() {
        scrollPosition = 0;
        updateScrollPosition();
        pauseScrolling();
    }

    // 优化的动画帧率控制
    function scrollAnimation(timestamp) {
        if (!isScrolling) return;
        
        // 更新性能监控
        performanceMonitor.update();
        
        // 计算帧与帧之间的时间差
        const elapsed = timestamp - lastFrameTime;
        
        // 基于实际帧率计算移动距离，确保匀速滚动
        const pixelsToMove = (scrollSpeed * elapsed) / frameDuration;
        
        if (scrollPosition < maxScroll) {
            scrollPosition += pixelsToMove;
            if (scrollPosition > maxScroll) scrollPosition = maxScroll;
            
            // 高效更新位置
            updateScrollPosition();
            
            // 仅在确实移动了的情况下更新图片
            if (pixelsToMove > 0) {
                updateVisibleImages();
            }
            
            lastFrameTime = timestamp;
            requestAnimationFrame(scrollAnimation);
        } else {
            pauseScrolling();
            // 动画结束后，自动退出到全屏状态
            exitToCinematics();
        }
    }
    
    // 更高效的位置更新
    function updateScrollPosition() {
        // 使用transform代替修改left属性，获得更好的性能
        container.style.transform = `translateX(-${scrollPosition}px)`;
    }
    
    // 更高效的图片可见性更新
    const visibilityCache = new Map();
    let activeSectionStart = 0;
    let activeSectionEnd = 0;
    const bufferDistance = 500; // 提前500像素加载图片
    
    function updateVisibleImages() {
        // 计算当前可见区域范围（添加缓冲区）
        const viewportStart = Math.max(0, scrollPosition - bufferDistance);
        const viewportEnd = scrollPosition + window.innerWidth + bufferDistance;
        
        // 如果视口范围没有明显变化，跳过更新
        if (Math.abs(viewportStart - activeSectionStart) < 100 && 
            Math.abs(viewportEnd - activeSectionEnd) < 100) {
            return;
        }
        
        activeSectionStart = viewportStart;
        activeSectionEnd = viewportEnd;
        
        // 仅处理当前视口附近的图片
        updateImageVisibility(popupImages);
    }
    
    function updateImageVisibility(images) {
        const currentPosition = scrollPosition;
        
        images.forEach((imgConfig, index) => {
            const imgElement = imgConfig.element;
            const shouldBeVisible = currentPosition >= imgConfig.showAtPosition && 
                                    currentPosition < imgConfig.hideAtPosition;
            
            // 检查缓存，避免不必要的DOM操作
            const cachedState = visibilityCache.get(imgElement);
            if (cachedState !== shouldBeVisible) {
                if (shouldBeVisible) {
                    imgElement.classList.add('active');
                } else {
                    imgElement.classList.remove('active');
                }
                visibilityCache.set(imgElement, shouldBeVisible);
            }
        });
    }

    // 退出到全屏状态
    function exitToCinematics() {
        // 等待最后一个图片显示完毕后再退出
        setTimeout(() => {
            // 添加全屏模式类
            body.classList.add('fullscreen-mode');
            
            // 隐藏控制按钮
            document.querySelector('.scroll-controls').style.opacity = '0';
            setTimeout(() => {
                document.querySelector('.scroll-controls').style.display = 'none';
            }, 1000);
            
            // 显示热点
            hotspots.forEach(hotspot => {
                hotspot.style.opacity = '1';
            });
            
            // 隐藏所有弹出图片
            popupImages.forEach(imgConfig => {
                imgConfig.element.classList.remove('active');
            });
            
            // 回到最左侧，并切换背景图片
            setTimeout(() => {
                scrollPosition = 0;
                container.style.transition = 'transform 1s ease, background-image 1s ease';
                // 切换背景图片
                container.style.backgroundImage = 'url("images/layer2/background_layer2.jpg")';
                updateScrollPosition();
                
                // 恢复transition设置
                setTimeout(() => {
                    container.style.transition = 'transform 0.5s ease';
                    // 启用手指拖动功能
                    enableDragging();
                }, 1000);
            }, 500);
        }, 1500);
    }

    // 新增拖动功能
    let isDragging = false;
    let startX = 0;
    let startScrollPosition = 0;
    
    function enableDragging() {
        console.log("启用拖动功能");
        
        // 处理触摸事件（移动设备）
        container.addEventListener('touchstart', handleDragStart, { passive: false });
        container.addEventListener('touchmove', handleDragMove, { passive: false });
        container.addEventListener('touchend', handleDragEnd);
        
        // 处理鼠标事件（桌面设备）
        container.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
    }
    
    function handleDragStart(e) {
        if (isScrolling) return; // 如果正在自动滚动，则不启用拖动
        
        isDragging = true;
        startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        startScrollPosition = scrollPosition;
        
        // 阻止默认行为，防止滚动冲突
        if (e.cancelable) {
            e.preventDefault();
        }
        
        // 暂时取消transition，以获得更流畅的拖动效果
        container.style.transition = 'none';
    }
    
    function handleDragMove(e) {
        if (!isDragging) return;
        
        // 计算拖动距离
        const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const deltaX = startX - x;
        
        // 更新滚动位置
        let newPosition = startScrollPosition + deltaX;
        
        // 限制滚动范围
        newPosition = Math.max(0, Math.min(newPosition, maxScroll));
        
        // 更新位置
        scrollPosition = newPosition;
        updateScrollPosition();
        
        // 阻止默认行为，防止滚动冲突
        if (e.cancelable) {
            e.preventDefault();
        }
    }
    
    function handleDragEnd(e) {
        if (!isDragging) return;
        
        isDragging = false;
        
        // 恢复transition效果
        container.style.transition = 'transform 0.5s ease';
    }

    // 初始化应用
    async function initializeApp() {
        console.log("开始初始化应用...");
        
        // 首先加载所有图片
        await preloadImages();
        
        // 然后创建DOM元素
        createIntroImages();
        createPopupImages();
        
        // 隐藏加载屏幕
        setTimeout(() => {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 1000);
            
            // 显示电影感黑边
            setTimeout(() => {
                topBar.style.height = '8%';
                bottomBar.style.height = '8%';
                
                // 开始卷轴滚动
                setTimeout(startScrolling, 1000);
            }, 500);
        }, 500);
    }

    // 页面加载完成后初始化
    window.addEventListener('load', initializeApp);

    // 绑定控制按钮事件
    pauseBtn.addEventListener('click', pauseScrolling);
    playBtn.addEventListener('click', startScrolling);
    restartBtn.addEventListener('click', resetScrolling);
    
    // 初始显示播放按钮
    pauseBtn.style.display = 'none';

    // 监听窗口大小变化，动态调整性能
    window.addEventListener('resize', () => {
        // 根据窗口大小调整滚动速度
        if (window.innerWidth < 768) {
            scrollSpeed = 2; // 较小的屏幕滚动慢一些
        } else {
            scrollSpeed = 3; // 大屏幕正常速度
        }
    });
    
    // 检测设备性能
    function checkDevicePerformance() {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
            // WebGL不可用，假定低性能设备
            return false;
        }
        
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (!debugInfo) {
            return true; // 无法确定，假定正常性能
        }
        
        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        // 检查是否为已知的低性能GPU
        if (/(intel|microsoft|swiftshader)/i.test(renderer)) {
            return false;
        }
        
        return true;
    }
    
    // 根据设备性能调整设置
    if (!checkDevicePerformance()) {
        console.log("检测到低性能设备，调整设置");
        scrollSpeed = 2;
        // 禁用一些效果
        document.body.classList.add('low-performance-mode');
    }
</script>
</body>
</html>